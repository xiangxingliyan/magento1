VarienForm=Class.create(),VarienForm.prototype={initialize:function(e,t){if(this.form=$(e),this.form&&(this.cache=$A(),this.currLoader=!1,this.currDataIndex=!1,this.validator=new Validation(this.form),this.elementFocus=this.elementOnFocus.bindAsEventListener(this),this.elementBlur=this.elementOnBlur.bindAsEventListener(this),this.childLoader=this.onChangeChildLoad.bindAsEventListener(this),this.highlightClass="highlight",this.extraChildParams="",this.firstFieldFocus=t||!1,this.bindElements(),this.firstFieldFocus))try{Form.Element.focus(Form.findFirstElement(this.form))}catch(e){}},submit:function(e){return this.validator&&this.validator.validate()&&this.form.submit(),!1},bindElements:function(){var e=Form.getElements(this.form);for(var t in e)e[t].id&&(Event.observe(e[t],"focus",this.elementFocus),Event.observe(e[t],"blur",this.elementBlur))},elementOnFocus:function(e){var t=Event.findElement(e,"fieldset");t&&Element.addClassName(t,this.highlightClass)},elementOnBlur:function(e){var t=Event.findElement(e,"fieldset");t&&Element.removeClassName(t,this.highlightClass)},setElementsRelation:function(e,t,i,s){(e=$(e))&&(this.cache[e.id]||(this.cache[e.id]=$A(),this.cache[e.id].child=t,this.cache[e.id].dataUrl=i,this.cache[e.id].data=$A(),this.cache[e.id].first=s||!1),Event.observe(e,"change",this.childLoader))},onChangeChildLoad:function(e){element=Event.element(e),this.elementChildLoad(element)},elementChildLoad:function(e,t){this.callback=t||!1,e.value&&(this.currLoader=e.id,this.currDataIndex=e.value,this.cache[e.id].data[e.value]?this.setDataToChild(this.cache[e.id].data[e.value]):new Ajax.Request(this.cache[this.currLoader].dataUrl,{method:"post",parameters:{parent:e.value},onComplete:this.reloadChildren.bind(this)}))},reloadChildren:function(e){var t=e.responseJSON||e.responseText.evalJSON(!0)||{};this.cache[this.currLoader].data[this.currDataIndex]=t,this.setDataToChild(t)},setDataToChild:function(e){if(e.length){var t=$(this.cache[this.currLoader].child);if(t){var i='<select name="'+t.name+'" id="'+t.id+'" class="'+t.className+'" title="'+t.title+'" '+this.extraChildParams+">";this.cache[this.currLoader].first&&(i+='<option value="">'+this.cache[this.currLoader].first+"</option>");for(var s in e)e[s].value&&(i+='<option value="'+e[s].value+'"',!t.value||t.value!=e[s].value&&t.value!=e[s].label||(i+=" selected"),i+=">"+e[s].label+"</option>");i+="</select>",Element.insert(t,{before:i}),Element.remove(t)}}else{var t=$(this.cache[this.currLoader].child);if(t){var i='<input type="text" name="'+t.name+'" id="'+t.id+'" class="'+t.className+'" title="'+t.title+'" '+this.extraChildParams+">";Element.insert(t,{before:i}),Element.remove(t)}}this.bindElements(),this.callback&&this.callback()}},RegionUpdater=Class.create(),RegionUpdater.prototype={initialize:function(e,t,i,s,n,l){this.countryEl=$(e),this.regionTextEl=$(t),this.regionSelectEl=$(i),this.zipEl=$(l),this.config=s.config,delete s.config,this.regions=s,this.disableAction=void 0===n?"hide":n,this.zipOptions="undefined"!=typeof zipOptions&&zipOptions,this.regionSelectEl.options.length<=1&&this.update(),Event.observe(this.countryEl,"change",this.update.bind(this))},_checkRegionRequired:function(){var e,t,i=[this.regionTextEl,this.regionSelectEl],s=this;if(void 0!==this.config){var n=this.config.regions_required.indexOf(this.countryEl.value)>=0;i.each(function(i){Validation.reset(i),e=$$('label[for="'+i.id+'"]')[0],e&&(t=e.down("em")||e.down("span.required"),s.config.show_all_regions||(n?e.up().show():e.up().hide())),e&&t&&(n?n&&(t.show(),e.hasClassName("required")||e.addClassName("required")):(t.hide(),e.hasClassName("required")&&e.removeClassName("required"))),n?(i.hasClassName("required-entry")||i.addClassName("required-entry"),"select"!=i.tagName.toLowerCase()||i.hasClassName("validate-select")||i.addClassName("validate-select")):(i.hasClassName("required-entry")&&i.removeClassName("required-entry"),"select"==i.tagName.toLowerCase()&&i.hasClassName("validate-select")&&i.removeClassName("validate-select"))})}},update:function(){if(this.regions[this.countryEl.value]){var e,t,i;i=this.regionSelectEl.getAttribute("defaultValue"),this.regionTextEl&&(i||(i=this.regionTextEl.value.toLowerCase()),this.regionTextEl.value=""),this.regionSelectEl.options.length=1;for(regionId in this.regions[this.countryEl.value])t=this.regions[this.countryEl.value][regionId],e=document.createElement("OPTION"),e.value=regionId,e.text=t.name.stripTags(),e.title=t.name,this.regionSelectEl.options.add?this.regionSelectEl.options.add(e):this.regionSelectEl.appendChild(e),(regionId==i||t.name&&t.name.toLowerCase()==i||t.name&&t.code.toLowerCase()==i)&&(this.regionSelectEl.value=regionId);this.sortSelect(),"hide"==this.disableAction?(this.regionTextEl&&(this.regionTextEl.style.display="none"),this.regionSelectEl.style.display=""):"disable"==this.disableAction&&(this.regionTextEl&&(this.regionTextEl.disabled=!0),this.regionSelectEl.disabled=!1),this.setMarkDisplay(this.regionSelectEl,!0)}else this.regionSelectEl.options.length=1,this.sortSelect(),"hide"==this.disableAction?(this.regionTextEl&&(this.regionTextEl.style.display=""),this.regionSelectEl.style.display="none",Validation.reset(this.regionSelectEl)):"disable"==this.disableAction?(this.regionTextEl&&(this.regionTextEl.disabled=!1),this.regionSelectEl.disabled=!0):"nullify"==this.disableAction&&(this.regionSelectEl.options.length=1,this.regionSelectEl.value="",this.regionSelectEl.selectedIndex=0,this.lastCountryId=""),this.setMarkDisplay(this.regionSelectEl,!1);this._checkRegionRequired(),new ZipUpdater(this.countryEl.value,this.zipEl).update()},setMarkDisplay:function(e,t){e=$(e);var i=e.up(0).down("label > span.required")||e.up(1).down("label > span.required")||e.up(0).down("label.required > em")||e.up(1).down("label.required > em");i&&(inputElement=i.up().next("input"),t?(i.show(),inputElement&&inputElement.addClassName("required-entry")):(i.hide(),inputElement&&inputElement.removeClassName("required-entry")))},sortSelect:function(){for(var e=this.regionSelectEl,t=new Array,i=$(e).value,s=0;s<$(e).options.length;s++)0!=s&&(t[s-1]=new Array,t[s-1][0]=$(e).options[s].text,t[s-1][1]=$(e).options[s].value);t.sort();for(var s=1;s<=t.length;s++){var n=new Option(t[s-1][0],t[s-1][1]);$(e).options[s]=n}$(e).value=i}},ZipUpdater=Class.create(),ZipUpdater.prototype={initialize:function(e,t){this.country=e,this.zipElement=$(t)},update:function(){if("undefined"==typeof optionalZipCountries)return!1;void 0!=this.zipElement?(Validation.reset(this.zipElement),this._setPostcodeOptional()):Event.observe(window,"load",this._setPostcodeOptional.bind(this))},_setPostcodeOptional:function(){if(this.zipElement=$(this.zipElement),void 0==this.zipElement)return!1;var e=$$('label[for="'+this.zipElement.id+'"]')[0];if(void 0!=e)var t=e.down("em")||e.down("span.required");if(-1!=optionalZipCountries.indexOf(this.country)){for(;this.zipElement.hasClassName("required-entry");)this.zipElement.removeClassName("required-entry");void 0!=t&&t.hide()}else this.zipElement.addClassName("required-entry"),void 0!=t&&t.show()}};